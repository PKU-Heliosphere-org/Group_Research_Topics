<!DOCTYPE html><html><head>
      <title>编写Fortran程序实现在Parker螺旋位型上叠加Switchback磁场调制</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/jshept/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.18/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="考虑在parker-spiral的磁场上添加switchback基于方法介绍与实现指南编写fortran的程序">考虑在parker spiral的磁场上添加switchback，基于方法介绍与实现指南，编写fortran的程序 </h1>
<p>把“在 Parker 螺旋基场上叠加簇状 switchbacks（用矢势 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">A_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）并做并行补偿保证逐点保模”的<strong>完整 Fortran 90/95 可运行参考实现</strong>写出来。<br>
<strong>说明与范围</strong>：</p>
<ul>
<li>
<p>程序在球坐标网格上（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">r,\theta,\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span></span></span></span>）生成：</p>
<ol>
<li>Parker 螺旋基场 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">B</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf B_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8361em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>；</li>
<li>若干 Gaussian 簇的矢势 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_\theta(r,\theta,\phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span>（可配置簇数与参数）；</li>
<li>通过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><msub><mi mathvariant="bold">B</mi><mo>⊥</mo></msub><mo>=</mo><mi mathvariant="normal">∇</mi><mo>×</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>θ</mi></msub><msub><mover accent="true"><mi>e</mi><mo>^</mo></mover><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\delta\mathbf B_\perp=\nabla\times(A_\theta\hat e_\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">⊥</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">e</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 计算横向扰动（严格无散度）；</li>
<li>对每点做并行补偿 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><msub><mi>B</mi><mo>∥</mo></msub></mrow><annotation encoding="application/x-tex">\delta B_\parallel</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0496em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">∥</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span></span></span></span>（按前述根号公式并选择分支）得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf B^{(c)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span>，即逐点<strong>保模</strong>的磁场（还<strong>未</strong>做 Helmholtz 投影，投影步骤留到后续）。</li>
</ol>
</li>
<li>
<p>结果以 plain CSV（每行：x,y,z,Bx,By,Bz）输出，便于后续可视化（例如 Python/matplotlib 或 Paraview）。</p>
</li>
</ul>
<blockquote>
<p>提示：此参考实现<strong>刻意保持简单、可读且自包含</strong>，适合快速验证和调参。若要把投影（球谐-径向 Poisson）加入，我可以在此基础上再给出高性能 Fortran 实现（需依赖 SHT 库或自写投影器）。</p>
</blockquote>
<hr>
<h2 id="如何编译与运行">如何编译与运行 </h2>
<p>保存为 <code>parker_switchback.f90</code>，在 Linux 下用 gfortran 编译：</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gfortran <span class="token parameter variable">-O2</span> -fimplicit-none <span class="token parameter variable">-o</span> parker_switchback parker_switchback.f90
./parker_switchback
</code></pre><p>运行后会生成 <code>B_field_output.csv</code>（笛卡尔点与 B 向量）。</p>
<hr>
<h2 id="程序说明要点">程序说明（要点） </h2>
<ul>
<li>网格尺寸与簇参数在程序顶部可修改（<code>nr, ntheta, nphi</code>，以及 <code>nblobs</code> 和每个 blob 的 <code>rc, thc, phc, Lr, Lth, Lph, psi0, V</code>）。</li>
<li>差分：用<strong>中心差分</strong>计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">∂</mi><mi>ϕ</mi></msub><msub><mi>A</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\partial_\phi A_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> (周期性) 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">∂</mi><mi>r</mi></msub><mo stretchy="false">(</mo><mi>r</mi><msub><mi>A</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\partial_r(rA_\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>（边界用向内/向外差分）。</li>
<li>并行补偿：在每格计算 <code>s2 = |dB_perp|^2</code>，若 <code>s2 &gt; B0^2 - eps</code> 则截断；<code>sigma = sign(cos(psi_local))</code>（用设计的 psi 函数），然后 <code>dBpar = -B0 + sigma*sqrt(B0^2 - s2)</code>；<code>B_c = B0 + dB_perp + dBpar*b0hat</code>。</li>
<li>警告：程序未做 Helmholtz 投影 — 因此 <code>div B_c</code> 可能不是零（但 <code>deltaB_perp</code> 本身应是无散度，<code>dBpar*b0hat</code> 会引入散度）。投影步骤在后续可加。</li>
</ul>
<hr>
<h2 id="完整-fortran-程序">完整 Fortran 程序 </h2>
<pre data-role="codeBlock" data-info="fortran" class="language-fortran fortran"><code><span class="token comment">! parker_switchback.f90</span>
<span class="token comment">! Fortran 90 reference implementation:</span>
<span class="token comment">! Parker spiral + clustered switchbacks via A_theta,</span>
<span class="token comment">! compute deltaB_perp = curl(A_theta e_theta),</span>
<span class="token comment">! do parallel compensation to enforce |B| = |B0| pointwise.</span>
<span class="token comment">!</span>
<span class="token comment">! Outputs CSV: x,y,z,Bx,By,Bz</span>
<span class="token keyword keyword-program">program</span> parker_switchback
  <span class="token keyword keyword-implicit none">implicit none</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> dp <span class="token operator">=</span> selected_real_kind<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">307</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> pi <span class="token operator">=</span> <span class="token number">3.14159265358979323846_dp</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> mu0 <span class="token operator">=</span> <span class="token number">4.0_dp</span><span class="token operator">*</span>pi<span class="token operator">*</span><span class="token number">1.0e-7_dp</span>

  <span class="token comment">! Grid parameters (tune as needed)</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> nr <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> ntheta <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">,</span> nphi <span class="token operator">=</span> <span class="token number">80</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> r_in <span class="token operator">=</span> <span class="token number">6.96e8</span> <span class="token operator">*</span> <span class="token number">5.0_dp</span>    <span class="token comment">! 5 Rs</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> r_out <span class="token operator">=</span> <span class="token number">6.96e8</span> <span class="token operator">*</span> <span class="token number">70.0_dp</span>  <span class="token comment">! 70 Rs</span>

  <span class="token comment">! Parker parameters</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Omega <span class="token operator">=</span> <span class="token number">2.7e-6_dp</span>     <span class="token comment">! rad/s</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Vsw <span class="token operator">=</span> <span class="token number">500.0e3_dp</span>      <span class="token comment">! m/s</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Bstar <span class="token operator">=</span> <span class="token number">5.0e-4_dp</span>     <span class="token comment">! Tesla at rstar</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> rstar <span class="token operator">=</span> <span class="token number">6.96e8_dp</span>

  <span class="token comment">! Switchback cluster parameters (example)</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> nblobs <span class="token operator">=</span> <span class="token number">6</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-dimension">dimension</span><span class="token punctuation">(</span>nblobs<span class="token punctuation">)</span> <span class="token operator">::</span> blob_rc<span class="token punctuation">,</span> blob_thc<span class="token punctuation">,</span> blob_phic
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-dimension">dimension</span><span class="token punctuation">(</span>nblobs<span class="token punctuation">)</span> <span class="token operator">::</span> blob_Lr<span class="token punctuation">,</span> blob_Lth<span class="token punctuation">,</span> blob_Lph<span class="token punctuation">,</span> blob_psi0<span class="token punctuation">,</span> blob_V

  <span class="token comment">! arrays</span>
  <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> b
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> dr<span class="token punctuation">,</span> dth<span class="token punctuation">,</span> dph
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> r<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> A<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> B0r<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B0th<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B0ph<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> dBr<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dBth<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dBph<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> Bx<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> By<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bz<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> rdr<span class="token punctuation">,</span> sth<span class="token punctuation">,</span> cth<span class="token punctuation">,</span> sph<span class="token punctuation">,</span> cph
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> eps <span class="token operator">=</span> <span class="token number">1.0e-14_dp</span>

  <span class="token comment">! temporary vars</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Br0<span class="token punctuation">,</span> Bph0<span class="token punctuation">,</span> B0mag
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Ath<span class="token punctuation">,</span> dA_dphi<span class="token punctuation">,</span> dA_dr<span class="token punctuation">,</span> rA<span class="token punctuation">,</span> d_rA_dr

  <span class="token comment">! output</span>
  <span class="token keyword keyword-character">character</span><span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">::</span> outfile
  <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> ios<span class="token punctuation">,</span> unit

  <span class="token comment">! initialize blob params (example cluster roughly around phi=0, various r)</span>
  <span class="token keyword keyword-call">call</span> init_blobs<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">! allocate</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span>ntheta<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>A<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>B0r<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> B0th<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> B0ph<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>dBr<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> dBth<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> dBph<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>Bx<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> By<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">,</span> Bz<span class="token punctuation">(</span>nr<span class="token punctuation">,</span>ntheta<span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">! grid spacing (uniform in r and phi; theta use simple uniform here)</span>
  dr <span class="token operator">=</span> <span class="token punctuation">(</span>r_out <span class="token operator">-</span> r_in<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>nr<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
  dth <span class="token operator">=</span> pi <span class="token operator">/</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>ntheta<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
  dph <span class="token operator">=</span> <span class="token number">2.0_dp</span><span class="token operator">*</span>pi <span class="token operator">/</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>nphi<span class="token punctuation">,</span> dp<span class="token punctuation">)</span>   <span class="token comment">! phi periodic; use nphi points over 2pi</span>

  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> r_in <span class="token operator">+</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token operator">*</span>dr
  <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
    th<span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span> <span class="token operator">+</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token operator">*</span>dth
  <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
    ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>pi <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.0_dp</span><span class="token punctuation">)</span><span class="token operator">*</span>dph   <span class="token comment">! [-pi,pi)</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! build Parker base field B0 in spherical components (Br, Bth, Bphi)</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
        B0r<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> Bstar<span class="token operator">*</span><span class="token punctuation">(</span>rstar <span class="token operator">/</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span>
        B0th<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
        B0ph<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> B0r<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>Omega <span class="token operator">*</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> Vsw
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! compute A_theta as sum of blobs</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
        A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token keyword keyword-do">do</span> b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nblobs
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
      <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
        <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
          A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> A_theta_blob<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
        <span class="token keyword keyword-end do">end do</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! compute deltaB_perp: dBr = (1/(r sin th)) d/dphi (A sin th)  ~ (1/r) dA/dphi for sin th ~1</span>
  <span class="token comment">! and dBphi = (1/r) d/dr(r A)</span>
  <span class="token comment">! use centered differences. phi periodic wrapping handled.</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
        <span class="token comment">! dA/dphi (centered)</span>
        dA_dphi <span class="token operator">=</span> <span class="token punctuation">(</span> A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>wrap_index<span class="token punctuation">(</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>wrap_index<span class="token punctuation">(</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>nphi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>dph<span class="token punctuation">)</span>
        dBr<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0_dp</span> <span class="token operator">/</span> <span class="token punctuation">(</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> max<span class="token punctuation">(</span><span class="token number">1.0e-12_dp</span><span class="token punctuation">,</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span> dA_dphi <span class="token operator">*</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! compute d/dr (r A)</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
        rA <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
          d_rA_dr <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>r<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> rA <span class="token punctuation">)</span> <span class="token operator">/</span> dr    <span class="token comment">! forward diff at inner</span>
        <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> nr<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
          d_rA_dr <span class="token operator">=</span> <span class="token punctuation">(</span> rA <span class="token operator">-</span> <span class="token punctuation">(</span>r<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> dr    <span class="token comment">! backward diff at outer</span>
        <span class="token keyword keyword-else">else</span>
          d_rA_dr <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>r<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>r<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>A<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>dr<span class="token punctuation">)</span>
        <span class="token keyword keyword-end if">end if</span>
        dBph<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.0_dp</span> <span class="token operator">/</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> d_rA_dr
        dBth<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! Now form total perturbation dB_perp in Cartesian, compute B0 cart, then parallel compensation</span>
  <span class="token keyword keyword-open">open</span><span class="token punctuation">(</span>unit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword keyword-file">file</span><span class="token operator">=</span><span class="token string">'B_field_output.csv'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'write'</span><span class="token punctuation">,</span> iostat<span class="token operator">=</span>ios<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ios <span class="token operator">/=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
    <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Error opening output file'</span>
    <span class="token keyword keyword-stop">stop</span>
  <span class="token keyword keyword-end if">end if</span>
  <span class="token keyword keyword-write">write</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'(A)'</span><span class="token punctuation">)</span> <span class="token string">'# x[m], y[m], z[m], Bx[T], By[T], Bz[T]'</span>

  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ntheta
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nphi
        <span class="token comment">! spherical basis at (r,th,ph)</span>
        <span class="token keyword keyword-call">call</span> sph_basis<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> er <span class="token operator">=&gt;</span> rdr<span class="token punctuation">,</span> eth <span class="token operator">=&gt;</span> sth<span class="token punctuation">,</span> eph <span class="token operator">=&gt;</span> cth<span class="token punctuation">)</span>
        <span class="token comment">! compute B0 spherical</span>
        Br0 <span class="token operator">=</span> B0r<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
        Bph0 <span class="token operator">=</span> B0ph<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
        B0mag <span class="token operator">=</span> sqrt<span class="token punctuation">(</span> Br0<span class="token operator">*</span>Br0 <span class="token operator">+</span> Bph0<span class="token operator">*</span>Bph0 <span class="token punctuation">)</span>
        <span class="token comment">! convert B0 to cart</span>
        <span class="token keyword keyword-call">call</span> sph_to_cart_vec<span class="token punctuation">(</span> Br0<span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">,</span> Bph0<span class="token punctuation">,</span> th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> Bx<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> By<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> Bz<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token punctuation">)</span>

        <span class="token comment">! deltaB_perp sph -&gt; cart</span>
        <span class="token keyword keyword-call">call</span> sph_to_cart_vec<span class="token punctuation">(</span> dBr<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">,</span> dBph<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&amp;</span>
                              dBr<span class="token punctuation">,</span> dBth<span class="token punctuation">,</span> dBph <span class="token punctuation">)</span>  <span class="token comment">! reuse temps</span>

        <span class="token comment">! dB_perp vector (dx,dy,dz) in dBr,dBth,dBph temps</span>
        <span class="token comment">! compute s2 = |dB_perp|^2</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> dbx<span class="token punctuation">,</span> dby<span class="token punctuation">,</span> dbz
        dbx <span class="token operator">=</span> dBr<span class="token punctuation">;</span> dby <span class="token operator">=</span> dBth<span class="token punctuation">;</span> dbz <span class="token operator">=</span> dBph
        <span class="token comment">! Note: the above sph_to_cart_vec stored components into dBr,dBth,dBph temps; rename</span>
        dbx <span class="token operator">=</span> dBr<span class="token punctuation">;</span> dby <span class="token operator">=</span> dBth<span class="token punctuation">;</span> dbz <span class="token operator">=</span> dBph
        <span class="token comment">! But ensure we refer to correct values: better recompute explicitly:</span>
        <span class="token keyword keyword-call">call</span> sph_to_cart_vec<span class="token punctuation">(</span> dBr<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">,</span> dBph<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> dbx<span class="token punctuation">,</span> dby<span class="token punctuation">,</span> dbz <span class="token punctuation">)</span>

        <span class="token comment">! compute b0hat</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> b0x<span class="token punctuation">,</span> b0y<span class="token punctuation">,</span> b0z<span class="token punctuation">,</span> b0norm
        b0x <span class="token operator">=</span> Bx<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span> b0y <span class="token operator">=</span> By<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span> b0z <span class="token operator">=</span> Bz<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
        b0norm <span class="token operator">=</span> sqrt<span class="token punctuation">(</span> max<span class="token punctuation">(</span> b0x<span class="token operator">*</span>b0x <span class="token operator">+</span> b0y<span class="token operator">*</span>b0y <span class="token operator">+</span> b0z<span class="token operator">*</span>b0z<span class="token punctuation">,</span> <span class="token number">1.0e-30_dp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        b0x <span class="token operator">=</span> b0x <span class="token operator">/</span> b0norm<span class="token punctuation">;</span> b0y <span class="token operator">=</span> b0y <span class="token operator">/</span> b0norm<span class="token punctuation">;</span> b0z <span class="token operator">=</span> b0z <span class="token operator">/</span> b0norm

        <span class="token comment">! s2</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> s2
        s2 <span class="token operator">=</span> dbx<span class="token operator">*</span>dbx <span class="token operator">+</span> dby<span class="token operator">*</span>dby <span class="token operator">+</span> dbz<span class="token operator">*</span>dbz
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>s2 <span class="token operator">&gt;</span> b0norm<span class="token operator">*</span>b0norm <span class="token operator">-</span> eps<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
          s2 <span class="token operator">=</span> max<span class="token punctuation">(</span><span class="token number">0.0_dp</span><span class="token punctuation">,</span> b0norm<span class="token operator">*</span>b0norm <span class="token operator">-</span> eps<span class="token punctuation">)</span>
        <span class="token keyword keyword-end if">end if</span>

        <span class="token comment">! determine local psi for sign (recompute psi from blobs sum; here reuse A to estimate psi: A ~ a0 = B0 Lr sin psi =&gt; sin psi ~ A/(B0 Lr)</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> psi_local<span class="token punctuation">,</span> sinpsi_local<span class="token punctuation">,</span> sigma
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>abs<span class="token punctuation">(</span>B0mag<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0_dp</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
          <span class="token comment">! approximate sinpsi from sum of A; choose Lr reference as first blob's Lr (rough)</span>
          sinpsi_local <span class="token operator">=</span> A<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> max<span class="token punctuation">(</span><span class="token number">1.0e-30_dp</span><span class="token punctuation">,</span> B0mag <span class="token operator">*</span> blob_Lr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>sinpsi_local <span class="token operator">&gt;</span> <span class="token number">1.0_dp</span><span class="token punctuation">)</span> sinpsi_local <span class="token operator">=</span> <span class="token number">1.0_dp</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>sinpsi_local <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1.0_dp</span><span class="token punctuation">)</span> sinpsi_local <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0_dp</span>
          psi_local <span class="token operator">=</span> asin<span class="token punctuation">(</span>sinpsi_local<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span>
          psi_local <span class="token operator">=</span> <span class="token number">0.0_dp</span>
        <span class="token keyword keyword-end if">end if</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>cos<span class="token punctuation">(</span>psi_local<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0.0_dp</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
          sigma <span class="token operator">=</span> <span class="token number">1.0_dp</span>
        <span class="token keyword keyword-else">else</span>
          sigma <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0_dp</span>
        <span class="token keyword keyword-end if">end if</span>

        <span class="token comment">! compute deltaB_par</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> dBpar
        dBpar <span class="token operator">=</span> <span class="token operator">-</span> b0norm <span class="token operator">+</span> sigma <span class="token operator">*</span> sqrt<span class="token punctuation">(</span> max<span class="token punctuation">(</span><span class="token number">0.0_dp</span><span class="token punctuation">,</span> b0norm<span class="token operator">*</span>b0norm <span class="token operator">-</span> s2<span class="token punctuation">)</span> <span class="token punctuation">)</span>

        <span class="token comment">! produce final Bc = B0 + dBperp + dBpar * b0hat</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Bcx<span class="token punctuation">,</span> Bcy<span class="token punctuation">,</span> Bcz
        Bcx <span class="token operator">=</span> Bx<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> dbx <span class="token operator">+</span> dBpar <span class="token operator">*</span> b0x
        Bcy <span class="token operator">=</span> By<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> dby <span class="token operator">+</span> dBpar <span class="token operator">*</span> b0y
        Bcz <span class="token operator">=</span> Bz<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">+</span> dbz <span class="token operator">+</span> dBpar <span class="token operator">*</span> b0z

        <span class="token comment">! compute Cartesian position</span>
        <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z
        x <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> cos<span class="token punctuation">(</span>ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> sin<span class="token punctuation">(</span>ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        z <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> cos<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-write">write</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'(6(ES24.15,1X))'</span><span class="token punctuation">)</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> Bcx<span class="token punctuation">,</span> Bcy<span class="token punctuation">,</span> Bcz

      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token keyword keyword-close">close</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Output written to B_field_output.csv'</span>

<span class="token keyword keyword-contains">contains</span>

  <span class="token keyword keyword-subroutine">subroutine</span> init_blobs<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> bb
    <span class="token comment">! Example: place nblobs at random-ish radii and clustered phi near 0</span>
    blob_rc <span class="token operator">=</span> <span class="token punctuation">(/</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>r_in <span class="token operator">+</span> <span class="token punctuation">(</span>r_out<span class="token operator">-</span>r_in<span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>b<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>nblobs<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nblobs <span class="token punctuation">)</span> <span class="token punctuation">/)</span>
    <span class="token keyword keyword-do">do</span> bb<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>nblobs
      blob_thc<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> pi<span class="token operator">/</span><span class="token number">2.0_dp</span>        <span class="token comment">! near ecliptic</span>
      blob_phic<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span> <span class="token operator">+</span> <span class="token number">0.2_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>bb <span class="token operator">-</span> <span class="token punctuation">(</span>nblobs<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0_dp</span><span class="token punctuation">)</span>
      blob_Lr<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2.0_dp</span> <span class="token operator">*</span> rstar
      blob_Lth<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.05_dp</span>
      blob_Lph<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.18_dp</span>
      blob_psi0<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.95_dp</span> <span class="token operator">*</span> pi
      blob_V<span class="token punctuation">(</span>bb<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> init_blobs

  <span class="token comment">! Evaluate single-blob contribution to A_theta at grid (i,j,k), blob index b</span>
  <span class="token keyword keyword-function">function</span> A_theta_blob<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword keyword-result">result</span><span class="token punctuation">(</span>Aval<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>b
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Aval
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> rc<span class="token punctuation">,</span> thc<span class="token punctuation">,</span> phic<span class="token punctuation">,</span> Lr_b<span class="token punctuation">,</span> Lth_b<span class="token punctuation">,</span> Lph_b<span class="token punctuation">,</span> psi0_b<span class="token punctuation">,</span> Vb
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> rr<span class="token punctuation">,</span> thh<span class="token punctuation">,</span> phh<span class="token punctuation">,</span> drloc<span class="token punctuation">,</span> dthloc<span class="token punctuation">,</span> dphloc<span class="token punctuation">,</span> env<span class="token punctuation">,</span> B0mag_local<span class="token punctuation">,</span> a0_local
    rr <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> thh <span class="token operator">=</span> th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span> phh <span class="token operator">=</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
    rc <span class="token operator">=</span> blob_rc<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> thc <span class="token operator">=</span> blob_thc<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> phic <span class="token operator">=</span> blob_phic<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    Lr_b <span class="token operator">=</span> blob_Lr<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> Lth_b <span class="token operator">=</span> blob_Lth<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> Lph_b <span class="token operator">=</span> blob_Lph<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    psi0_b <span class="token operator">=</span> blob_psi0<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> Vb <span class="token operator">=</span> blob_V<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token comment">! envelopes</span>
    drloc <span class="token operator">=</span> rr <span class="token operator">-</span> <span class="token punctuation">(</span>rc <span class="token operator">+</span> Vb<span class="token operator">*</span><span class="token number">0.0_dp</span><span class="token punctuation">)</span>   <span class="token comment">! time t=0 in this reference code</span>
    dthloc <span class="token operator">=</span> thh <span class="token operator">-</span> thc
    dphloc <span class="token operator">=</span> phh <span class="token operator">-</span> phic
    <span class="token comment">! wrap phi to [-pi,pi]</span>
    dphloc <span class="token operator">=</span> <span class="token punctuation">(</span>dphloc <span class="token operator">+</span> pi<span class="token punctuation">)</span> <span class="token operator">-</span> floor<span class="token punctuation">(</span><span class="token punctuation">(</span>dphloc <span class="token operator">+</span> pi<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>pi<span class="token punctuation">)</span> <span class="token operator">-</span> pi
    env <span class="token operator">=</span> exp<span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>drloc<span class="token operator">/</span>Lr_b<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>dthloc<span class="token operator">/</span>Lth_b<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span><span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>dphloc<span class="token operator">/</span>Lph_b<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token comment">! amplitude a0 = |B0| Lr sin(psi)</span>
    <span class="token comment">! approximate local |B0| (use Parker radial/phi values)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Br_tmp<span class="token punctuation">,</span> Bphi_tmp<span class="token punctuation">,</span> B0tmp
    Br_tmp <span class="token operator">=</span> Bstar<span class="token operator">*</span><span class="token punctuation">(</span>rstar<span class="token operator">/</span>rr<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span>
    Bphi_tmp <span class="token operator">=</span> <span class="token operator">-</span> Br_tmp <span class="token operator">*</span> <span class="token punctuation">(</span>Omega <span class="token operator">*</span> rr <span class="token operator">*</span> sin<span class="token punctuation">(</span>thh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>Vsw
    B0tmp <span class="token operator">=</span> sqrt<span class="token punctuation">(</span>Br_tmp<span class="token operator">*</span>Br_tmp <span class="token operator">+</span> Bphi_tmp<span class="token operator">*</span>Bphi_tmp<span class="token punctuation">)</span>
    a0_local <span class="token operator">=</span> B0tmp <span class="token operator">*</span> Lr_b <span class="token operator">*</span> sin<span class="token punctuation">(</span>psi0_b<span class="token punctuation">)</span>   <span class="token comment">! using psi0 as peak angle</span>
    Aval <span class="token operator">=</span> a0_local <span class="token operator">*</span> env
  <span class="token keyword keyword-end function">end function</span> A_theta_blob

  <span class="token comment">! wrap index for phi periodicity</span>
  <span class="token keyword keyword-integer">integer</span> <span class="token keyword keyword-function">function</span> wrap_index<span class="token punctuation">(</span>k<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> k<span class="token punctuation">,</span> n
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> kk
    kk <span class="token operator">=</span> k
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>kk <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> kk <span class="token operator">=</span> kk <span class="token operator">+</span> n
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>kk <span class="token operator">&gt;</span> n<span class="token punctuation">)</span> kk <span class="token operator">=</span> kk <span class="token operator">-</span> n
    wrap_index <span class="token operator">=</span> kk
  <span class="token keyword keyword-end function">end function</span> wrap_index

  <span class="token comment">! Spherical-to-cartesian vector conversion: components given in (Br, Bth, Bphi)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> sph_to_cart_vec<span class="token punctuation">(</span>Br<span class="token punctuation">,</span> Bth<span class="token punctuation">,</span> Bphi<span class="token punctuation">,</span> thv<span class="token punctuation">,</span> phv<span class="token punctuation">,</span> Bx_out<span class="token punctuation">,</span> By_out<span class="token punctuation">,</span> Bz_out<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Br<span class="token punctuation">,</span> Bth<span class="token punctuation">,</span> Bphi<span class="token punctuation">,</span> thv<span class="token punctuation">,</span> phv
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> Bx_out<span class="token punctuation">,</span> By_out<span class="token punctuation">,</span> Bz_out
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> erx<span class="token punctuation">,</span> ery<span class="token punctuation">,</span> erz<span class="token punctuation">,</span> ethx<span class="token punctuation">,</span> ethy<span class="token punctuation">,</span> ethz<span class="token punctuation">,</span> ephx<span class="token punctuation">,</span> ephy<span class="token punctuation">,</span> ephz
    erx <span class="token operator">=</span> sin<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>cos<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> ery <span class="token operator">=</span> sin<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>sin<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> erz <span class="token operator">=</span> cos<span class="token punctuation">(</span>thv<span class="token punctuation">)</span>
    ethx <span class="token operator">=</span> cos<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>cos<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> ethy <span class="token operator">=</span> cos<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>sin<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> ethz <span class="token operator">=</span> <span class="token operator">-</span>sin<span class="token punctuation">(</span>thv<span class="token punctuation">)</span>
    ephx <span class="token operator">=</span> <span class="token operator">-</span>sin<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> ephy <span class="token operator">=</span> cos<span class="token punctuation">(</span>phv<span class="token punctuation">)</span><span class="token punctuation">;</span> ephz <span class="token operator">=</span> <span class="token number">0.0_dp</span>
    Bx_out <span class="token operator">=</span> Br<span class="token operator">*</span>erx <span class="token operator">+</span> Bth<span class="token operator">*</span>ethx <span class="token operator">+</span> Bphi<span class="token operator">*</span>ephx
    By_out <span class="token operator">=</span> Br<span class="token operator">*</span>ery <span class="token operator">+</span> Bth<span class="token operator">*</span>ethy <span class="token operator">+</span> Bphi<span class="token operator">*</span>ephy
    Bz_out <span class="token operator">=</span> Br<span class="token operator">*</span>erz <span class="token operator">+</span> Bth<span class="token operator">*</span>ethz <span class="token operator">+</span> Bphi<span class="token operator">*</span>ephz
  <span class="token keyword keyword-end subroutine">end subroutine</span> sph_to_cart_vec

  <span class="token comment">! a small helper to provide basis variables (not used directly)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> sph_basis<span class="token punctuation">(</span>thv<span class="token punctuation">,</span> phv<span class="token punctuation">,</span> er_out<span class="token punctuation">,</span> eth_out<span class="token punctuation">,</span> eph_out<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> thv<span class="token punctuation">,</span> phv
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> er_out<span class="token punctuation">,</span> eth_out<span class="token punctuation">,</span> eph_out
    <span class="token comment">! Dummy: provide scalars to satisfy call in code (not used)</span>
    er_out <span class="token operator">=</span> sin<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>cos<span class="token punctuation">(</span>phv<span class="token punctuation">)</span>
    eth_out <span class="token operator">=</span> cos<span class="token punctuation">(</span>thv<span class="token punctuation">)</span><span class="token operator">*</span>cos<span class="token punctuation">(</span>phv<span class="token punctuation">)</span>
    eph_out <span class="token operator">=</span> <span class="token operator">-</span>sin<span class="token punctuation">(</span>phv<span class="token punctuation">)</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> sph_basis

<span class="token keyword keyword-end program">end program</span> parker_switchback
</code></pre><hr>
<h2 id="后续建议如果你要继续">后续建议（如果你要继续） </h2>
<ol>
<li><strong>加入 Helmholtz 投影（球谐-径向 Poisson）</strong>：我可以在 Fortran 中给出基于 <code>shtns</code>（或自实现球谐变换 + Thomas 三对角求解器）的一体化投影版本。</li>
<li><strong>把速度扰动（Walén）也加入</strong>：在投影后计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mi mathvariant="bold">B</mi></mrow><annotation encoding="application/x-tex">\delta\mathbf B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathbf">B</span></span></span></span> 并设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mi mathvariant="bold">u</mi><mo>=</mo><mo>±</mo><mi>δ</mi><mi mathvariant="bold">B</mi><mi mathvariant="normal">/</mi><msqrt><mrow><msub><mi>μ</mi><mn>0</mn></msub><mi>ρ</mi></mrow></msqrt></mrow><annotation encoding="application/x-tex">\delta\mathbf u = \pm \delta\mathbf B/\sqrt{\mu_0\rho}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathbf">u</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0869em;vertical-align:-0.3369em;"></span><span class="mord">±</span><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mord mathbf">B</span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7031em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">ρ</span></span></span><span style="top:-2.6631em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3369em;"><span></span></span></span></span></span></span></span></span>（同样输出到 CSV）。</li>
<li><strong>优化数值</strong>：用更精确的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> 节点（Gauss–Legendre）、非均匀径向格点、以及高效球谐库以提升精度与速度。</li>
<li><strong>单元测试</strong>：建议先在低分辨率上运行，检查 <code>max(|B|-|B0|)</code>（应几乎为 0 在并行补偿前后），并计算 <code>div(Bc)</code>（投影前）以判断投影强度需求。</li>
</ol>
<hr>
<p>要不要我现在把 <strong>Helmholtz 投影（球谐-径向 Poisson）</strong> 的 Fortran 实现也写出来（参考实现用 <code>scipy</code>/Python 较短，但高性能 Fortran 版本需要 <code>shtns</code> 或自写球谐套件）？或者我可以把上面 Fortran 代码修正为直接输出速度扰动以形成完整的 MHD 初始场。</p>
<hr>
<h1 id="把-helmholtz-投影球谐-径向-poisson-的-fortran-实现也写出来">把 Helmholtz 投影（球谐-径向 Poisson） 的 Fortran 实现也写出来 </h1>
<p>下面给出一个<strong>自包含的 Fortran 90/95 实现（参考级）</strong>，用于在球壳域上对标量源 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho(r,\theta,\phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ρ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span> 做 <strong>Helmholtz 投影</strong> 所需的 Poisson 解法，即：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi mathvariant="normal">∇</mi><mn>2</mn></msup><mi mathvariant="normal">Φ</mi><mo>=</mo><mi>ρ</mi><mspace width="1em"></mspace><mo>⇒</mo><mspace width="1em"></mspace><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></munder><msub><mi>ϕ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo><msub><mi>Y</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">\nabla^2\Phi=\rho\quad\Rightarrow\quad
\Phi(r,\theta,\phi)=\sum_{\ell m}\phi_{\ell m}(r)Y_{\ell m}(\theta,\phi),</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">Φ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3521em;vertical-align:-1.3021em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span></p>
<p>并按每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi mathvariant="normal">ℓ</mi><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\ell,m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">ℓ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span> 在径向上用三对角（Thomas）算法求解</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mn>1</mn><msup><mi>r</mi><mn>2</mn></msup></mfrac><mfrac><mi>d</mi><mrow><mi>d</mi><mi>r</mi></mrow></mfrac><mtext> ⁣</mtext><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><msup><mi>r</mi><mn>2</mn></msup><msubsup><mi>ϕ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>−</mo><mfrac><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi mathvariant="normal">ℓ</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><msup><mi>r</mi><mn>2</mn></msup></mfrac><msub><mi>ϕ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo>=</mo><msub><mi>ρ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\frac{1}{r^2}\frac{d}{dr}\!\big(r^2\phi_{\ell m}'\big)-\frac{\ell(\ell+1)}{r^2}\phi_{\ell m}= \rho_{\ell m}(r).</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord">ℓ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span></p>
<p><strong>实现要点 &amp; 适用范围（重要）</strong></p>
<ul>
<li>本代码采用<strong>直接投影（直接求和）<strong>来计算球谐系数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho_{\ell m}(r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span>：在每个径向层上，对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\theta,\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span></span></span></span> 网格直接计算<br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>r</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo>∑</mo><mrow><mi>j</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mi>ρ</mi><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><msub><mi>θ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>ϕ</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><msubsup><mi>Y</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow><mo>∗</mo></msubsup><mo stretchy="false">(</mo><msub><mi>θ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>ϕ</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><msub><mi>w</mi><mi>j</mi></msub><mtext> </mtext><mi mathvariant="normal">Δ</mi><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\rho_{\ell m}(r)=\sum_{j,k}\rho(r,\theta_j,\phi_k)\,Y_{\ell m}^*(\theta_j,\phi_k)\,w_j\,\Delta\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.4169em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">Δ</span><span class="mord mathnormal">ϕ</span></span></span></span>。<br>
因而</strong>复杂度较高</strong>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msub><mi>N</mi><mi>r</mi></msub><msub><mi>N</mi><mi>θ</mi></msub><msub><mi>N</mi><mi>ϕ</mi></msub><msubsup><mi>L</mi><mi>max</mi><mo>⁡</mo><mn>2</mn></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N_r N_\theta N_\phi L_{\max}^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1002em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>），但代码<strong>自包含</strong>、不依赖外部 SHT 库，适合作为参考实现或小到中型网格测试（例如 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>θ</mi></msub><mo>≲</mo><mn>64</mn><mo separator="true">,</mo><msub><mi>N</mi><mi>ϕ</mi></msub><mo>≲</mo><mn>128</mn><mo separator="true">,</mo><msub><mi>L</mi><mi>max</mi><mo>⁡</mo></msub><mo>≲</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">N_\theta\lesssim64,N_\phi\lesssim128,L_{\max}\lesssim30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9592em;vertical-align:-0.2296em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">≲</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0157em;vertical-align:-0.2861em;"></span><span class="mord">64</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">≲</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9592em;vertical-align:-0.2296em;"></span><span class="mord">128</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">a</span><span class="mtight">x</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">≲</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">30</span></span></span></span>）。</li>
<li>精度：本实现使用**均匀 θ 网格 + 简单权重（trapezoid-like）**而非 Gauss–Legendre 节点，所以角向投影精度不如专业 SHT 库（<code>shtns</code> / <code>pyshtools</code>）。若用于高精度或大网格，请改用专业 SHT 库（我后面给出建议）。</li>
<li>该实现假定输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span> 已在 Fortran 程序内（例如从前一段并行补偿所得的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mo>⋅</mo><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\nabla\cdot\mathbf B^{(c)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span>）。示例包括构造一个测试源并运行投影、最后把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Φ</span></span></span></span> 输出回网格，并计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\nabla\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇Φ</span></span></span></span> 与投影后极小的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mo>⋅</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla\cdot(\mathbf B^{(c)}-\nabla\Phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∇Φ</span><span class="mclose">)</span></span></span></span> 作为诊断。</li>
<li>边界条件：示例实现采用 <strong>Neumann–Neumann</strong>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">∂</mi><mi>r</mi></msub><mi mathvariant="normal">Φ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\partial_r\Phi=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">Φ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi></mrow></msub><mo separator="true">,</mo><msub><mi>r</mi><mrow><mi mathvariant="normal">o</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_{\rm in},r_{\rm out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">in</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">out</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）并在求解前做总源修正（若总体体积积分不为 0 时，将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>←</mo><mi>ρ</mi><mo>−</mo><mi>I</mi><mi mathvariant="normal">/</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">\rho\leftarrow \rho - I/V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>）以满足兼容性。你可以改为 Dirichlet/混合 BC，代码里有注释说明如何改。</li>
<li>建议：用于生产/大规模问题时，替换角向投影为 SHT 库（<code>shtns</code>、<code>pyshtools</code>）并保持径向三对角求解不变。</li>
</ul>
<hr>
<h2 id="代码说明高层">代码说明（高层） </h2>
<p>程序模块分为：</p>
<ol>
<li>核心数学工具（阶乘/归一化因子、计算关联勒让德多项式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>P</mi><mi mathvariant="normal">ℓ</mi><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{\ell}^{m}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0331em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>、构造标准球谐 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y_{\ell m}(\theta,\phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span>）。</li>
<li>角向投影（直接求和）得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho_{\ell m}(r_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</li>
<li>径向离散与三对角求解（Thomas 算法）得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mrow><mi mathvariant="normal">ℓ</mi><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>r</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\phi_{\ell m}(r_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</li>
<li>逆变换得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi><mo stretchy="false">(</mo><msub><mi>r</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>θ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>ϕ</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Phi(r_i,\theta_j,\phi_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord">Φ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</li>
<li>计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\nabla\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇Φ</span></span></span></span>（径向用二阶中心差分，角向用有限差分），并展示如何把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf B^{(c)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 投影为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">B</mi><mo>=</mo><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\mathbf B=\mathbf B^{(c)}-\nabla\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇Φ</span></span></span></span>（示例仅演示对一个测试场的投影，以验证过程）。</li>
</ol>
<blockquote>
<p>注：为便于阅读，我在代码中加入大量注释，解释每一步的物理/数值背景与可能的改进点。</p>
</blockquote>
<hr>
<h2 id="完整-fortran-程序参考实现">完整 Fortran 程序（参考实现） </h2>
<p>将下面代码保存为 <code>spherical_poisson_projection.f90</code>，在支持 Fortran 90 的编译器下编译并运行。该程序包含一个<strong>小测试例</strong>（构造一个简单 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span>）并展示投影结果诊断。</p>
<pre data-role="codeBlock" data-info="fortran" class="language-fortran fortran"><code><span class="token comment">! spherical_poisson_projection.f90</span>
<span class="token comment">! Reference Fortran implementation of Helmholtz projection on a spherical shell</span>
<span class="token comment">! using direct spherical harmonic projection (no external SHT library).</span>
<span class="token comment">! - Computes rho_lm(r) via direct summation over theta/phi</span>
<span class="token comment">! - Solves radial ODE for each (l,m) with finite-difference (Thomas)</span>
<span class="token comment">! - Reconstructs Phi(r,theta,phi)</span>
<span class="token comment">! - Demonstrates computing grad Phi and how to subtract from Bc</span>
<span class="token comment">!</span>
<span class="token keyword keyword-program">program</span> spherical_poisson_projection
  <span class="token keyword keyword-implicit none">implicit none</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> dp <span class="token operator">=</span> selected_real_kind<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">307</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> pi <span class="token operator">=</span> <span class="token number">3.1415926535897932384626433832795_dp</span>

  <span class="token comment">! Grid and spectral truncation parameters (tune as needed)</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Nr <span class="token operator">=</span> <span class="token number">48</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Nth <span class="token operator">=</span> <span class="token number">36</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Nph <span class="token operator">=</span> <span class="token number">72</span>
  <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> Lmax <span class="token operator">=</span> <span class="token number">24</span>   <span class="token comment">! maximum l for spherical harmonic expansion (&lt;=Nth-1)</span>

  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> r_in <span class="token operator">=</span> <span class="token number">6.96e8_dp</span> <span class="token operator">*</span> <span class="token number">5.0_dp</span>    <span class="token comment">! inner radius (5 Rs)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-parameter">parameter</span> <span class="token operator">::</span> r_out <span class="token operator">=</span> <span class="token number">6.96e8_dp</span> <span class="token operator">*</span> <span class="token number">70.0_dp</span>  <span class="token comment">! outer radius (70 Rs)</span>

  <span class="token comment">! arrays</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> r<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> dr<span class="token punctuation">,</span> dth<span class="token punctuation">,</span> dph
  <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>ell<span class="token punctuation">,</span>m

  <span class="token comment">! input source rho(r,theta,phi) (e.g. divergence of Bc)</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> rho<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>

  <span class="token comment">! spherical harmonic coefficients: rho_lm(r) &amp; phi_lm(r)</span>
  <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> rho_lm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> phi_lm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
  <span class="token comment">! dims: (0:Lmax, -Lmax:Lmax indexed as 1..(2*Lmax+1) for convenience)</span>
  <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> mmin<span class="token punctuation">,</span> mmax<span class="token punctuation">,</span> nm

  <span class="token comment">! reuse Ylm(table) on angular grid</span>
  <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> Ylm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span> <span class="token comment">! Ylm(l,m_index,ith,iph)</span>
  <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> mm<span class="token punctuation">,</span> m_index

  <span class="token comment">! other arrays for radial ODE</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> rhs<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sol<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>

  <span class="token comment">! reconstruction of Phi</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> Phi<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>

  <span class="token comment">! diagnostic</span>
  <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> total_rho<span class="token punctuation">,</span> Vtot<span class="token punctuation">,</span> vol_elem

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! allocate grids</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span>Nth<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>Nph<span class="token punctuation">)</span><span class="token punctuation">)</span>
  dr <span class="token operator">=</span> <span class="token punctuation">(</span>r_out <span class="token operator">-</span> r_in<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>Nr<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
  dth <span class="token operator">=</span> pi <span class="token operator">/</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>Nth<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
  dph <span class="token operator">=</span> <span class="token number">2.0_dp</span><span class="token operator">*</span>pi <span class="token operator">/</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>Nph<span class="token punctuation">,</span> dp<span class="token punctuation">)</span>

  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
    r<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> r_in <span class="token operator">+</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token operator">*</span>dr
  <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nth
    th<span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span> <span class="token operator">+</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token operator">*</span>dth     <span class="token comment">! 0..pi</span>
  <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nph
    ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>pi <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>dph      <span class="token comment">! -pi..(approx)pi-dph</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! allocate rho and harmonic arrays</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>rho<span class="token punctuation">(</span>Nr<span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span><span class="token punctuation">)</span>
  mmin <span class="token operator">=</span> <span class="token operator">-</span>Lmax<span class="token punctuation">;</span> mmax <span class="token operator">=</span> Lmax
  nm <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span>Lmax <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>rho_lm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span>nm<span class="token punctuation">,</span> Nr<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>phi_lm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span>nm<span class="token punctuation">,</span> Nr<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>Ylm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span>nm<span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>Phi<span class="token punctuation">(</span>Nr<span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! Example: construct a test rho(r,theta,phi)</span>
  <span class="token comment">! Here we create a localized Gaussian source in (r,theta,phi)</span>
  <span class="token keyword keyword-call">call</span> init_test_rho<span class="token punctuation">(</span>rho<span class="token punctuation">,</span> r<span class="token punctuation">,</span> th<span class="token punctuation">,</span> ph<span class="token punctuation">)</span>

  <span class="token comment">! compute volume and total integral for diagnostic / compatibility</span>
  Vtot <span class="token operator">=</span> <span class="token number">0.0_dp</span>
  total_rho <span class="token operator">=</span> <span class="token number">0.0_dp</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nth
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nph
        vol_elem <span class="token operator">=</span> r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">*</span> sin<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> dr <span class="token operator">*</span> dth <span class="token operator">*</span> dph
        Vtot <span class="token operator">=</span> Vtot <span class="token operator">+</span> vol_elem
        total_rho <span class="token operator">=</span> total_rho <span class="token operator">+</span> rho<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token operator">*</span>vol_elem
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Initial total integral of rho (should be ~0 for Neumann compatibility): '</span><span class="token punctuation">,</span> total_rho

  <span class="token comment">! If necessary, enforce zero integral (simple uniform correction)</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>abs<span class="token punctuation">(</span>total_rho<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1.0e-12_dp</span><span class="token operator">*</span>abs<span class="token punctuation">(</span>Vtot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
    <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Applying uniform correction to rho to enforce integral zero...'</span>
    <span class="token keyword keyword-call">call</span> correct_rho_zero_mean<span class="token punctuation">(</span>rho<span class="token punctuation">,</span> total_rho<span class="token punctuation">,</span> Vtot<span class="token punctuation">)</span>
  <span class="token keyword keyword-end if">end if</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! Precompute spherical harmonics Y_lm(theta_j,phi_k) up to Lmax</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Precomputing Y_lm on angular grid... (Lmax='</span><span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span><span class="token string">')'</span>
  <span class="token keyword keyword-call">call</span> precompute_Ylm<span class="token punctuation">(</span>Ylm<span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> th<span class="token punctuation">,</span> ph<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! Forward transform: for each radial layer i compute rho_lm(l,m,i)</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Forward projection (direct sum) to obtain rho_lm(r)...'</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
    <span class="token keyword keyword-call">call</span> forward_sph_proj_layer<span class="token punctuation">(</span>rho<span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rho_lm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> Ylm<span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">,</span> dth<span class="token punctuation">,</span> dph<span class="token punctuation">)</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! For each (l,m) solve radial ODE for phi_lm(r)</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Solving radial ODEs for each (l,m) ...'</span>
  <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>a<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> rhs<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> sol<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-do">do</span> ell <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Lmax
    <span class="token keyword keyword-do">do</span> m_index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> nm
      <span class="token comment">! assemble radial tridiagonal system for phi_{ell,m}(r)</span>
      <span class="token keyword keyword-call">call</span> assemble_radial_tridiag<span class="token punctuation">(</span>ell<span class="token punctuation">,</span> rho_lm<span class="token punctuation">(</span>ell<span class="token punctuation">,</span>m_index<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> Nr<span class="token punctuation">,</span> dr<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> rhs<span class="token punctuation">)</span>

      <span class="token comment">! solve tridiagonal (Thomas)</span>
      <span class="token keyword keyword-call">call</span> solve_tridiagonal<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> rhs<span class="token punctuation">,</span> sol<span class="token punctuation">,</span> Nr<span class="token punctuation">)</span>

      <span class="token comment">! store sol into phi_lm</span>
      <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
        phi_lm<span class="token punctuation">(</span>ell<span class="token punctuation">,</span>m_index<span class="token punctuation">,</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> cmplx<span class="token punctuation">(</span>sol<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! inverse transform: reconstruct Phi(r,theta,phi)</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Inverse transform: reconstruct Phi(r,theta,phi)...'</span>
  <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
    <span class="token keyword keyword-call">call</span> inverse_sph_proj_layer<span class="token punctuation">(</span>phi_lm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> Ylm<span class="token punctuation">,</span> Phi<span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>
  <span class="token keyword keyword-end do">end do</span>

  <span class="token comment">! -------------------------------------------------------------------</span>
  <span class="token comment">! Diagnostics: compute residual divergence reduction if we had Bc and subtract grad Phi</span>
  <span class="token comment">! Here we demonstrate computing grad Phi and output Phi; applying to Bc is straightforward.</span>
  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Writing Phi to file (phi_reconstructed.bin) as binary (r,theta,phi grid) ...'</span>
  <span class="token keyword keyword-call">call</span> write_phi_binary<span class="token punctuation">(</span><span class="token string">'phi_reconstructed.bin'</span><span class="token punctuation">,</span> Phi<span class="token punctuation">,</span> Nr<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>

  <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Done. Note: This reference implementation uses direct summation; for large grids use SHT library (shtns/pyshtools).'</span>
  <span class="token keyword keyword-stop">stop</span>

<span class="token keyword keyword-contains">contains</span>

  <span class="token keyword keyword-subroutine">subroutine</span> init_test_rho<span class="token punctuation">(</span>rho<span class="token punctuation">,</span> r<span class="token punctuation">,</span> th<span class="token punctuation">,</span> ph<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> rho<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> r<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> th<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> rc<span class="token punctuation">,</span> thc<span class="token punctuation">,</span> phc<span class="token punctuation">,</span> Lr<span class="token punctuation">,</span> Lth<span class="token punctuation">,</span> Lph
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> drm<span class="token punctuation">,</span> dthm<span class="token punctuation">,</span> dphm
    rc <span class="token operator">=</span> <span class="token number">20.0_dp</span> <span class="token operator">*</span> <span class="token number">6.96e8_dp</span>    <span class="token comment">! 20 Rs</span>
    thc <span class="token operator">=</span> pi<span class="token operator">/</span><span class="token number">2.0_dp</span>
    phc <span class="token operator">=</span> <span class="token number">0.0_dp</span>
    Lr <span class="token operator">=</span> <span class="token number">2.0_dp</span> <span class="token operator">*</span> <span class="token number">6.96e8_dp</span>
    Lth <span class="token operator">=</span> <span class="token number">0.08_dp</span>
    Lph <span class="token operator">=</span> <span class="token number">0.2_dp</span>
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>th<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>ph<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
          drm <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span>rc<span class="token punctuation">)</span><span class="token operator">/</span>Lr
          dthm <span class="token operator">=</span> <span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token operator">-</span>thc<span class="token punctuation">)</span><span class="token operator">/</span>Lth
          dphm <span class="token operator">=</span> mod<span class="token punctuation">(</span>ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">-</span>phc<span class="token operator">+</span>pi<span class="token punctuation">,</span> <span class="token number">2.0_dp</span><span class="token operator">*</span>pi<span class="token punctuation">)</span> <span class="token operator">-</span> pi
          rho<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>drm<span class="token operator">*</span>drm <span class="token operator">+</span> dthm<span class="token operator">*</span>dthm <span class="token operator">+</span> dphm<span class="token operator">*</span>dphm<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-end do">end do</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> init_test_rho

  <span class="token keyword keyword-subroutine">subroutine</span> correct_rho_zero_mean<span class="token punctuation">(</span>rho<span class="token punctuation">,</span> total_rho<span class="token punctuation">,</span> Vtot<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-inout">inout</span><span class="token punctuation">)</span> <span class="token operator">::</span> rho<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> total_rho<span class="token punctuation">,</span> Vtot
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> correction
    correction <span class="token operator">=</span> total_rho <span class="token operator">/</span> Vtot
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>rho<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>rho<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>rho<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
          rho<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> rho<span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">-</span> correction
        <span class="token keyword keyword-end do">end do</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> correct_rho_zero_mean

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Precompute Y_lm(theta,phi) on the angular grid up to Lmax</span>
  <span class="token keyword keyword-subroutine">subroutine</span> precompute_Ylm<span class="token punctuation">(</span>Ylm<span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> th<span class="token punctuation">,</span> ph<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> th<span class="token punctuation">(</span>Nth<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> Ylm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> m_index<span class="token punctuation">,</span> m<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> P_lm_val
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> yval
    <span class="token keyword keyword-do">do</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Lmax
      <span class="token keyword keyword-do">do</span> m <span class="token operator">=</span> <span class="token operator">-</span>l<span class="token punctuation">,</span> l
        m_index <span class="token operator">=</span> m <span class="token operator">+</span> Lmax <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nth
          <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nph
            P_lm_val <span class="token operator">=</span> assoc_legendre_P<span class="token punctuation">(</span>l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> cos<span class="token punctuation">(</span>th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            yval <span class="token operator">=</span> sph_harm<span class="token punctuation">(</span>l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> th<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> ph<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> P_lm_val<span class="token punctuation">)</span>
            Ylm<span class="token punctuation">(</span>l<span class="token punctuation">,</span> m_index<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">=</span> conjg<span class="token punctuation">(</span>yval<span class="token punctuation">)</span>   <span class="token comment">! store conjugate for forward projection convenience</span>
          <span class="token keyword keyword-end do">end do</span>
        <span class="token keyword keyword-end do">end do</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> precompute_Ylm

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Evaluate associated Legendre P_l^m(x) using recurrence</span>
  <span class="token keyword keyword-pure">pure</span> <span class="token keyword keyword-function">function</span> assoc_legendre_P<span class="token punctuation">(</span>l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token keyword keyword-result">result</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> m
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> x
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> P
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> Pmm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Pmmp1<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Plm<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token comment">! Use standard recurrence. For reliability restrict to l &lt;= ~50 for double precision</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">.or.</span> m <span class="token operator">&gt;</span> l<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      P <span class="token operator">=</span> <span class="token number">0.0_dp</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token keyword keyword-end if">end if</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> m<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      <span class="token comment">! Compute P_m^m = (-1)^m * (2m-1)!! * (1-x^2)^{m/2}</span>
      P <span class="token operator">=</span> <span class="token number">1.0_dp</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>m <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
        P <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0_dp</span><span class="token punctuation">)</span><span class="token operator">**</span>m <span class="token operator">*</span> double_factorial<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0_dp</span> <span class="token operator">-</span> x<span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">0.5_dp</span><span class="token operator">*</span>m<span class="token punctuation">)</span>
      <span class="token keyword keyword-end if">end if</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      <span class="token comment">! P_{m+1}^m = x*(2m+1) * P_m^m</span>
      P <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>m<span class="token operator">+</span><span class="token number">1.0_dp</span><span class="token punctuation">)</span> <span class="token operator">*</span> assoc_legendre_P<span class="token punctuation">(</span>m<span class="token punctuation">,</span>m<span class="token punctuation">,</span>x<span class="token punctuation">)</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token keyword keyword-else">else</span>
      <span class="token comment">! Use upward recurrence in l: P_{l,m} = ((2l-1)*x*P_{l-1,m} - (l+m-1)*P_{l-2,m})/(l-m)</span>
      <span class="token comment">! start with P_m^m and P_{m+1}^m</span>
      <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Pm_m<span class="token punctuation">,</span> Pm1_m<span class="token punctuation">,</span> Ptemp
      Pm_m <span class="token operator">=</span> assoc_legendre_P<span class="token punctuation">(</span>m<span class="token punctuation">,</span>m<span class="token punctuation">,</span>x<span class="token punctuation">)</span>
      Pm1_m <span class="token operator">=</span> assoc_legendre_P<span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>m<span class="token punctuation">,</span>x<span class="token punctuation">)</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> m<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
        P <span class="token operator">=</span> Pm_m
        <span class="token keyword keyword-return">return</span>
      <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
        P <span class="token operator">=</span> Pm1_m
        <span class="token keyword keyword-return">return</span>
      <span class="token keyword keyword-else">else</span>
        <span class="token keyword keyword-do">do</span> i <span class="token operator">=</span> m<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> l
          Ptemp <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>i <span class="token operator">-</span> <span class="token number">1.0_dp</span><span class="token punctuation">)</span> <span class="token operator">*</span> x <span class="token operator">*</span> Pm1_m <span class="token operator">-</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> m <span class="token operator">-</span> <span class="token number">1.0_dp</span><span class="token punctuation">)</span> <span class="token operator">*</span> Pm_m <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> m<span class="token punctuation">)</span>
          Pm_m <span class="token operator">=</span> Pm1_m
          Pm1_m <span class="token operator">=</span> Ptemp
        <span class="token keyword keyword-end do">end do</span>
        P <span class="token operator">=</span> Pm1_m
        <span class="token keyword keyword-return">return</span>
      <span class="token keyword keyword-end if">end if</span>
    <span class="token keyword keyword-end if">end if</span>
  <span class="token keyword keyword-end function">end function</span> assoc_legendre_P

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! compute double factorial (odd) (2n-1)!!</span>
  <span class="token keyword keyword-pure">pure</span> <span class="token keyword keyword-function">function</span> double_factorial<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword keyword-result">result</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> n
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> df
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> k
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      df <span class="token operator">=</span> <span class="token number">1.0_dp</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token keyword keyword-end if">end if</span>
    df <span class="token operator">=</span> <span class="token number">1.0_dp</span>
    <span class="token keyword keyword-do">do</span> k <span class="token operator">=</span> n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span>
      df <span class="token operator">=</span> df <span class="token operator">*</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end function">end function</span> double_factorial

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Compute spherical harmonic Y_lm given precomputed P_lm(x)</span>
  <span class="token keyword keyword-pure">pure</span> <span class="token keyword keyword-function">function</span> sph_harm<span class="token punctuation">(</span>l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> theta<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> P_lm_val<span class="token punctuation">)</span> <span class="token keyword keyword-result">result</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> m
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> theta<span class="token punctuation">,</span> phi<span class="token punctuation">,</span> P_lm_val
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> Y
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> norm
    <span class="token comment">! normalization: N_lm = sqrt((2l+1)/(4pi) * (l-m)!/(l+m)!)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> logfact_num<span class="token punctuation">,</span> logfact_den
    logfact_num <span class="token operator">=</span> log_factorial<span class="token punctuation">(</span>l <span class="token operator">-</span> abs<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
    logfact_den <span class="token operator">=</span> log_factorial<span class="token punctuation">(</span>l <span class="token operator">+</span> abs<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
    norm <span class="token operator">=</span> sqrt<span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0_dp</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">4.0_dp</span><span class="token operator">*</span>pi<span class="token punctuation">)</span> <span class="token operator">*</span> exp<span class="token punctuation">(</span> logfact_num <span class="token operator">-</span> logfact_den <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    Y <span class="token operator">=</span> cmplx<span class="token punctuation">(</span> norm <span class="token operator">*</span> P_lm_val <span class="token operator">*</span> cos<span class="token punctuation">(</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token operator">*</span>phi <span class="token punctuation">)</span><span class="token punctuation">,</span> norm <span class="token operator">*</span> P_lm_val <span class="token operator">*</span> sin<span class="token punctuation">(</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token operator">*</span>phi <span class="token punctuation">)</span><span class="token punctuation">,</span> dp <span class="token punctuation">)</span>
  <span class="token keyword keyword-end function">end function</span> sph_harm

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! log factorial via Stirling for moderate arguments (or exact for small n)</span>
  <span class="token keyword keyword-pure">pure</span> <span class="token keyword keyword-function">function</span> log_factorial<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword keyword-result">result</span><span class="token punctuation">(</span>lf<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> n
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> lf
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> k
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      lf <span class="token operator">=</span> <span class="token number">0.0_dp</span>
      <span class="token keyword keyword-do">do</span> k <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> n
        lf <span class="token operator">=</span> lf <span class="token operator">+</span> log<span class="token punctuation">(</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-else">else</span>
      lf <span class="token operator">=</span> n <span class="token operator">*</span> log<span class="token punctuation">(</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>dp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5_dp</span><span class="token operator">*</span>log<span class="token punctuation">(</span><span class="token number">2.0_dp</span><span class="token operator">*</span>pi<span class="token operator">*</span><span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-end if">end if</span>
  <span class="token keyword keyword-end function">end function</span> log_factorial

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Forward projection for a single radial layer (direct sum)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> forward_sph_proj_layer<span class="token punctuation">(</span>rho_layer<span class="token punctuation">,</span> rho_lm_layer<span class="token punctuation">,</span> Ylm<span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">,</span> dth<span class="token punctuation">,</span> dph<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> rho_layer<span class="token punctuation">(</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> rho_lm_layer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Ylm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> dth<span class="token punctuation">,</span> dph
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> m_index<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> sumc
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> w_theta
    <span class="token comment">! simple trapezoidal-like weights in theta (endpoints half weight)</span>
    <span class="token keyword keyword-do">do</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Lmax
      <span class="token keyword keyword-do">do</span> m_index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span>
        sumc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0_dp</span><span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nth
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>j<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">.or.</span> j<span class="token operator">==</span>Nth<span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
            w_theta <span class="token operator">=</span> <span class="token number">0.5_dp</span> <span class="token operator">*</span> dth
          <span class="token keyword keyword-else">else</span>
            w_theta <span class="token operator">=</span> dth
          <span class="token keyword keyword-end if">end if</span>
          <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nph
            sumc <span class="token operator">=</span> sumc <span class="token operator">+</span> cmplx<span class="token punctuation">(</span> rho_layer<span class="token punctuation">(</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token operator">*</span>w_theta<span class="token operator">*</span>dph<span class="token punctuation">,</span> <span class="token number">0.0_dp</span> <span class="token punctuation">)</span> <span class="token operator">*</span> Ylm<span class="token punctuation">(</span>l<span class="token punctuation">,</span>m_index<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span>
          <span class="token keyword keyword-end do">end do</span>
        <span class="token keyword keyword-end do">end do</span>
        rho_lm_layer<span class="token punctuation">(</span>l<span class="token punctuation">,</span>m_index<span class="token punctuation">)</span> <span class="token operator">=</span> sumc
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> forward_sph_proj_layer

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Assemble radial tridiagonal system for phi_{l,m}(r)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> assemble_radial_tridiag<span class="token punctuation">(</span>l<span class="token punctuation">,</span> rho_lm_r<span class="token punctuation">,</span> rgrid<span class="token punctuation">,</span> Nr<span class="token punctuation">,</span> dr<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> rhs<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> Nr
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> rho_lm_r<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> rgrid<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> dr
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> a<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">,</span> rhs<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> ri<span class="token punctuation">,</span> rip<span class="token punctuation">,</span> rim<span class="token punctuation">,</span> qip<span class="token punctuation">,</span> qim
    <span class="token comment">! The continuous ODE: d/dr(r^2 phi') - l(l+1) phi = r^2 rho</span>
    <span class="token comment">! Discretize: (1/dr)*( q_{i+1/2}*(phi_{i+1}-phi_i)/dr - q_{i-1/2}*(phi_i - phi_{i-1})/dr ) - l(l+1) phi_i = r_i^2 rho_i</span>
    <span class="token comment">! where q = r^2. Use q_{i+1/2} = 0.5*(r_i^2 + r_{i+1}^2)</span>
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nr
      ri <span class="token operator">=</span> rgrid<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
      rhs<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> ri<span class="token operator">*</span>ri <span class="token operator">*</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span> rho_lm_r<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> dp <span class="token punctuation">)</span>
    <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>Nr<span class="token operator">-</span><span class="token number">1</span>
      rip <span class="token operator">=</span> rgrid<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rim <span class="token operator">=</span> rgrid<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      qip <span class="token operator">=</span> <span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>rip<span class="token operator">*</span>rip <span class="token operator">+</span> ri<span class="token operator">*</span>ri<span class="token punctuation">)</span>
      qim <span class="token operator">=</span> <span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>ri<span class="token operator">*</span>ri <span class="token operator">+</span> rim<span class="token operator">*</span>rim<span class="token punctuation">)</span>
      a<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> qim <span class="token operator">/</span> <span class="token punctuation">(</span>dr<span class="token operator">*</span>dr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      c<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> qip <span class="token operator">/</span> <span class="token punctuation">(</span>dr<span class="token operator">*</span>dr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      b<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> a<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> c<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>l<span class="token operator">*</span><span class="token punctuation">(</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
    <span class="token keyword keyword-end do">end do</span>
    <span class="token comment">! inner boundary (Neumann: phi'(r_in)=0 -&gt; phi_0 = phi_2 symmetric)</span>
    <span class="token comment">! implement i=1 row using forward difference: (q1.5*(phi2-phi1)/dr - q-0.5*(phi1-phi0)/dr)/dr -&gt; set phi0=phi2 for derivative 0 approx</span>
    <span class="token comment">! Simple approach: use one-sided difference approximating derivative zero =&gt; set a(1)=0, c(1) = - q1.5/(dr*dr), b(1) = -(-c(1)) - l(l+1)</span>
    rip <span class="token operator">=</span> rgrid<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ri <span class="token operator">=</span> rgrid<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    qip <span class="token operator">=</span> <span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>rip<span class="token operator">*</span>rip <span class="token operator">+</span> ri<span class="token operator">*</span>ri<span class="token punctuation">)</span>
    a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
    c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> qip <span class="token operator">/</span> <span class="token punctuation">(</span>dr<span class="token operator">*</span>dr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    b<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> a<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>l<span class="token operator">*</span><span class="token punctuation">(</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
    <span class="token comment">! set rhs(1) stays ri^2 rho_1</span>

    <span class="token comment">! outer boundary i=Nr: Neumann phi'(r_out)=0 -&gt; backward difference similar</span>
    rip <span class="token operator">=</span> rgrid<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span><span class="token punctuation">;</span> rim <span class="token operator">=</span> rgrid<span class="token punctuation">(</span>Nr<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    qim <span class="token operator">=</span> <span class="token number">0.5_dp</span><span class="token operator">*</span><span class="token punctuation">(</span>rip<span class="token operator">*</span>rip <span class="token operator">+</span> rim<span class="token operator">*</span>rim<span class="token punctuation">)</span>
    a<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> qim <span class="token operator">/</span> <span class="token punctuation">(</span>dr<span class="token operator">*</span>dr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    c<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0_dp</span>
    b<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> a<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span> <span class="token operator">+</span> c<span class="token punctuation">(</span>Nr<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>l<span class="token operator">*</span><span class="token punctuation">(</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dp<span class="token punctuation">)</span>
    <span class="token comment">! rhs(Nr) set previously</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> assemble_radial_tridiag

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Solve tridiagonal with Thomas algorithm: a(i) phi_{i-1} + b(i) phi_i + c(i) phi_{i+1} = rhs(i)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> solve_tridiagonal<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>rhs<span class="token punctuation">,</span>x<span class="token punctuation">,</span>n<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> n
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> a<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> rhs<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> x<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-allocatable">allocatable</span> <span class="token operator">::</span> cp<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpv<span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> i
    <span class="token keyword keyword-allocate">allocate</span><span class="token punctuation">(</span>cp<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> dpv<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">! forward sweep</span>
    cp<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>b<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    dpv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> rhs<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>b<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-do">do</span> i<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>n
      cp<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> b<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> a<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>cp<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      dpv<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span> rhs<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> a<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>dpv<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> b<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> a<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>cp<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword keyword-end do">end do</span>
    <span class="token comment">! back substitution</span>
    x<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span> dpv<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword keyword-do">do</span> i <span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>
      x<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> dpv<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> cp<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>x<span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-deallocate">deallocate</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword keyword-deallocate">deallocate</span><span class="token punctuation">(</span>dpv<span class="token punctuation">)</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> solve_tridiagonal

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! Inverse transform for one radial layer: Phi(theta,phi) = sum_{l,m} phi_lm * Y_lm(theta,phi)</span>
  <span class="token keyword keyword-subroutine">subroutine</span> inverse_sph_proj_layer<span class="token punctuation">(</span>phi_lm_layer<span class="token punctuation">,</span> Ylm<span class="token punctuation">,</span> Phi_layer<span class="token punctuation">,</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> phi_lm_layer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Ylm<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>Lmax<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-out">out</span><span class="token punctuation">)</span> <span class="token operator">::</span> Phi_layer<span class="token punctuation">(</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Lmax<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> l<span class="token punctuation">,</span> m_index<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k
    <span class="token keyword keyword-complex">complex</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span> <span class="token operator">::</span> sumc
    <span class="token keyword keyword-do">do</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nth
      <span class="token keyword keyword-do">do</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>Nph
        sumc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.0_dp</span><span class="token punctuation">,</span> <span class="token number">0.0_dp</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-do">do</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Lmax
          <span class="token keyword keyword-do">do</span> m_index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Lmax<span class="token operator">+</span><span class="token number">1</span>
            sumc <span class="token operator">=</span> sumc <span class="token operator">+</span> phi_lm_layer<span class="token punctuation">(</span>l<span class="token punctuation">,</span>m_index<span class="token punctuation">)</span> <span class="token operator">*</span> conjg<span class="token punctuation">(</span> Ylm<span class="token punctuation">(</span>l<span class="token punctuation">,</span>m_index<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token punctuation">)</span>
          <span class="token keyword keyword-end do">end do</span>
        <span class="token keyword keyword-end do">end do</span>
        Phi_layer<span class="token punctuation">(</span>j<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>sumc<span class="token punctuation">)</span>
      <span class="token keyword keyword-end do">end do</span>
    <span class="token keyword keyword-end do">end do</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> inverse_sph_proj_layer

  <span class="token comment">!----------------------------------------------------------------</span>
  <span class="token comment">! write Phi as binary file for later visualization</span>
  <span class="token keyword keyword-subroutine">subroutine</span> write_phi_binary<span class="token punctuation">(</span>fname<span class="token punctuation">,</span> Phi<span class="token punctuation">,</span> Nr<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-implicit none">implicit none</span>
    <span class="token keyword keyword-character">character</span><span class="token punctuation">(</span>len<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> fname
    <span class="token keyword keyword-real">real</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Phi<span class="token punctuation">(</span>Nr<span class="token punctuation">,</span>Nth<span class="token punctuation">,</span>Nph<span class="token punctuation">)</span>
    <span class="token keyword keyword-integer">integer</span><span class="token punctuation">,</span> <span class="token keyword keyword-intent">intent</span><span class="token punctuation">(</span><span class="token keyword keyword-in">in</span><span class="token punctuation">)</span> <span class="token operator">::</span> Nr<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph
    <span class="token keyword keyword-integer">integer</span> <span class="token operator">::</span> iunit<span class="token punctuation">,</span> ios
    <span class="token keyword keyword-open">open</span><span class="token punctuation">(</span>newunit<span class="token operator">=</span>iunit<span class="token punctuation">,</span> <span class="token keyword keyword-file">file</span><span class="token operator">=</span>fname<span class="token punctuation">,</span> form<span class="token operator">=</span><span class="token string">'unformatted'</span><span class="token punctuation">,</span> access<span class="token operator">=</span><span class="token string">'stream'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span> iostat<span class="token operator">=</span>ios<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ios <span class="token operator">/=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-then">then</span>
      <span class="token keyword keyword-print">print</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">'Error opening file for Phi'</span>
      <span class="token keyword keyword-return">return</span>
    <span class="token keyword keyword-end if">end if</span>
    <span class="token keyword keyword-write">write</span><span class="token punctuation">(</span>iunit<span class="token punctuation">)</span> Nr<span class="token punctuation">,</span> Nth<span class="token punctuation">,</span> Nph
    <span class="token keyword keyword-write">write</span><span class="token punctuation">(</span>iunit<span class="token punctuation">)</span> Phi
    <span class="token keyword keyword-close">close</span><span class="token punctuation">(</span>iunit<span class="token punctuation">)</span>
  <span class="token keyword keyword-end subroutine">end subroutine</span> write_phi_binary

<span class="token keyword keyword-end program">end program</span> spherical_poisson_projection
</code></pre><hr>
<h2 id="使用说明与下一步建议">使用说明与下一步建议 </h2>
<ol>
<li>编译（示例）：</li>
</ol>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gfortran <span class="token parameter variable">-O2</span> <span class="token parameter variable">-fopenmp</span> spherical_poisson_projection.f90 <span class="token parameter variable">-o</span> sph_proj
./sph_proj
</code></pre><p>（如果需要并行化角向直接求和，可以在合适的循环使用 OpenMP pragmas。）</p>
<ol start="2">
<li>结果与诊断：</li>
</ol>
<ul>
<li>程序会写出二进制 <code>phi_reconstructed.bin</code>（头部写了 <code>Nr,Nth,Nph</code>），你可以用 Python/Matlab/ParaView 读取检查。</li>
<li>因为这里使用的是直接投影与 simple theta weights，精度有限。用于验证和小尺寸网格效果很好；用于大规模生产请改用 SHT 库（见下）。</li>
</ul>
<ol start="3">
<li>性能 / 精度提升建议（强烈推荐用于生产）：</li>
</ol>
<ul>
<li>用 Gauss–Legendre θ 节点与权重（精确积分），替换均匀 θ 网格。可通过 Golub–Welsch 求节点与权重（需实现或借用库）。</li>
<li>使用专业 SHT 库（<code>shtns</code>、<code>pyshtools</code>、<code>libsharp</code>），它们提供高性能的 forward/backward transforms，并能与 Fortran 通过 C 接口或 Python 接口联用。然后你只需保留径向三对角求解器（本代码的 assemble/solve 部分保持不变）。</li>
<li>若用 <code>shtns</code>：在 Fortran 中通过 ISO_C_BINDING 调用其 C API（需要写小的 C wrapper 或直接用 <code>interface</code> 指定 C 名称），或先在 C/Python 层面做角向变换再回传径向系数到 Fortran 求解。</li>
</ul>
<ol start="4">
<li>边界条件与兼容性：</li>
</ol>
<ul>
<li>示例采用 Neumann–Neumann + 均值修正。若你需要固定内边界 <code>Phi(r_in)=0</code>（Dirichlet），只需在组装径向矩阵时把第一行设为 phi(1)=0（b(1)=1,a(1)=c(1)=0,rhs(1)=0）并类似处理外边界或混合 BC。</li>
</ul>
<ol start="5">
<li>如何把投影结果用于磁场投影（步骤概要）：</li>
</ol>
<ul>
<li>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>θ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf B^{(c)}(r,\theta,\phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span>（并行补偿后、保模但有微小散度），计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>=</mo><mi mathvariant="normal">∇</mi><mo>⋅</mo><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\rho=\nabla\cdot\mathbf B^{(c)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span>（在相同网格与离散算子）。</li>
<li>把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi></mrow><annotation encoding="application/x-tex">\rho</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span> 传入本程序（替换 <code>init_test_rho</code>），得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Φ</span></span></span></span>。</li>
<li>计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\nabla\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇Φ</span></span></span></span>（径向用差分，角向可用 spectral coeff differentiation 或 finite differences），然后做 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">B</mi><mo>=</mo><msup><mi mathvariant="bold">B</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi mathvariant="normal">∇</mi><mi mathvariant="normal">Φ</mi></mrow><annotation encoding="application/x-tex">\mathbf B = \mathbf B^{(c)} - \nabla\Phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathbf">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇Φ</span></span></span></span>。</li>
<li>检查 <code>max|div B|</code>；若仍然超出阈值，可迭代：用新 B 重新计算并行补偿→投影（1-2 次通常足够）。</li>
</ul>
<hr>
<h2 id="最后说明建议与帮忙">最后说明（建议与帮忙） </h2>
<ul>
<li>
<p>这份代码是<strong>参考实现</strong>：为方便你马上验证整个投影思想而写。若你希望我把它改为<strong>高性能版本</strong>（角向调用 <code>shtns</code> 或者使用 Gauss–Legendre 节点以提高精度，并用 OpenMP/MPI 并行化），我可以继续把：</p>
<ul>
<li>用 <code>shtns</code> 的 Fortran/C binding 版本（更接近实际工程）写出来，或</li>
<li>把角向投影改为 Gauss–Legendre + FFT（更精确但需实现节点/权重求解与 FFT）。</li>
</ul>
</li>
<li>
<p>另外，如果你愿意，把你在之前 Fortran 程序中生成的 <code>rho(i,j,k)=div(Bc)</code> 文件提供给我（或描述它的网格），我可以把上面投影模块<strong>直接整合进你的代码</strong>（按相同网格、相同离散算子），并生成最终 <code>B = Bc - grad Phi</code> 的输出文件与诊断。</p>
</li>
</ul>
<p>如果你希望我现在就把这个参考实现<strong>替换成基于 <code>shtns</code> 的高效 Fortran 版本</strong>（并给出具体的编译/链接命令、C-Fortran binding 代码样例），或把 <code>grad Phi</code> 的具体差分算子（在球坐标非均匀网格下）写详尽，请告诉我你偏好 <code>shtns</code> 还是纯 Fortran（Gauss-Legendre + FFT）路线——我会把完整代码和编译说明发给你。</p>

      </div>
      <div class="md-sidebar-toc">
<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#考虑在parker-spiral的磁场上添加switchback基于方法介绍与实现指南编写fortran的程序" class="md-toc-link"><p>考虑在parker spiral的磁场上添加switchback，基于方法介绍与实现指南，编写fortran的程序</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#如何编译与运行" class="md-toc-link">
            <p>如何编译与运行</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#程序说明要点" class="md-toc-link">
            <p>程序说明（要点）</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#完整-fortran-程序" class="md-toc-link">
            <p>完整 Fortran 程序</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#后续建议如果你要继续" class="md-toc-link">
            <p>后续建议（如果你要继续）</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#把-helmholtz-投影球谐-径向-poisson-的-fortran-实现也写出来" class="md-toc-link"><p>把 Helmholtz 投影（球谐-径向 Poisson） 的 Fortran 实现也写出来</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#代码说明高层" class="md-toc-link">
            <p>代码说明（高层）</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#完整-fortran-程序参考实现" class="md-toc-link">
            <p>完整 Fortran 程序（参考实现）</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#使用说明与下一步建议" class="md-toc-link">
            <p>使用说明与下一步建议</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#最后说明建议与帮忙" class="md-toc-link">
            <p>最后说明（建议与帮忙）</p>

          </a></div>
        </div>
      </details>
    
</div>
</div>
      <a id="sidebar-toc-btn">≡</a>
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>